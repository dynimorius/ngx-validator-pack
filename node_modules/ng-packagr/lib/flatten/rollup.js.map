{"version":3,"file":"rollup.js","sourceRoot":"","sources":["../../../src/lib/flatten/rollup.ts"],"names":[],"mappings":"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","sourcesContent":["import rollupJson from '@rollup/plugin-json';\nimport nodeResolve from '@rollup/plugin-node-resolve';\nimport * as path from 'path';\nimport type { OutputAsset, OutputChunk, RollupCache } from 'rollup';\nimport { OutputFileCache } from '../ng-package/nodes';\nimport { readCacheEntry, saveCacheEntry } from '../utils/cache';\nimport * as log from '../utils/log';\nimport { fileLoaderPlugin } from './file-loader-plugin';\n\n/**\n * Options used in `ng-packagr` for writing flat bundle files.\n *\n * These options are passed through to rollup.\n */\nexport interface RollupOptions {\n  moduleName: string;\n  entry: string;\n  entryName: string;\n  dir: string;\n  sourceRoot: string;\n  cache?: RollupCache;\n  cacheDirectory?: string | false;\n  fileCache: OutputFileCache;\n  cacheKey: string;\n}\n\nlet rollup: typeof import('rollup') | undefined;\n\n/** Runs rollup over the given entry file, writes a bundle file. */\nexport async function rollupBundleFile(\n  opts: RollupOptions,\n): Promise<{ cache: RollupCache; files: (OutputChunk | OutputAsset)[] }> {\n  await ensureRollup();\n\n  log.debug(`rollup (v${rollup.VERSION}) ${opts.entry} to ${opts.dir}`);\n\n  const cacheDirectory = opts.cacheDirectory;\n\n  // Create the bundle\n  const bundle = await rollup.rollup({\n    context: 'this',\n    external: moduleId => isExternalDependency(moduleId),\n    cache: opts.cache ?? (cacheDirectory ? await readCacheEntry(cacheDirectory, opts.cacheKey) : undefined),\n    input: opts.entry,\n    plugins: [nodeResolve(), rollupJson(), fileLoaderPlugin(opts.fileCache)],\n    onwarn: warning => {\n      switch (warning.code) {\n        case 'CIRCULAR_DEPENDENCY':\n        case 'UNUSED_EXTERNAL_IMPORT':\n        case 'THIS_IS_UNDEFINED':\n          break;\n\n        default:\n          log.warn(warning.message);\n          break;\n      }\n    },\n    preserveSymlinks: true,\n    // Disable treeshaking when generating bundles\n    // see: https://github.com/angular/angular/pull/32069\n    treeshake: false,\n  });\n\n  // Output the bundle to disk\n  const output = await bundle.write({\n    name: opts.moduleName,\n    format: 'es',\n    dir: opts.dir,\n    inlineDynamicImports: false,\n    chunkFileNames: opts.entryName + '-[name]-[hash].mjs',\n    entryFileNames: opts.entryName + '.mjs',\n    banner: '',\n    sourcemap: true,\n  });\n\n  if (cacheDirectory) {\n    await saveCacheEntry(cacheDirectory, opts.cacheKey, JSON.stringify(bundle.cache));\n  }\n\n  // Close the bundle to let plugins clean up their external processes or services\n  await bundle.close();\n\n  return {\n    files: output.output,\n    cache: bundle.cache,\n  };\n}\n\nasync function ensureRollup(): Promise<void> {\n  if (rollup) {\n    return;\n  }\n\n  try {\n    rollup = await import('rollup');\n    log.debug(`rollup using native version.`);\n  } catch {\n    rollup = await import('@rollup/wasm-node');\n    log.debug(`rollup using wasm version.`);\n  }\n}\n\nfunction isExternalDependency(moduleId: string): boolean {\n  // more information about why we don't check for 'node_modules' path\n  // https://github.com/rollup/rollup-plugin-node-resolve/issues/110#issuecomment-350353632\n  if (moduleId.startsWith('.') || moduleId.startsWith('/') || path.isAbsolute(moduleId)) {\n    // if it's either 'absolute', marked to embed, starts with a '.' or '/' or is the umd bundle and is tslib\n    return false;\n  }\n\n  return true;\n}\n"]}